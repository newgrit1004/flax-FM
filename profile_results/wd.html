<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<style>
.r1 {color: #005f00; text-decoration-color: #005f00}
.r2 {font-weight: bold}
.r3 {color: #000080; text-decoration-color: #000080; font-weight: bold}
.r4 {color: #87af00; text-decoration-color: #87af00; font-weight: bold}
.r5 {color: #005f00; text-decoration-color: #005f00; font-weight: bold}
.r6 {color: #7f7f7f; text-decoration-color: #7f7f7f; font-weight: bold}
.r7 {color: #000080; text-decoration-color: #000080; font-weight: bold; font-style: italic}
.r8 {color: #87af00; text-decoration-color: #87af00; font-weight: bold; font-style: italic}
.r9 {color: #005f00; text-decoration-color: #005f00; font-weight: bold; font-style: italic}
.r10 {color: #7f7f7f; text-decoration-color: #7f7f7f}
.r11 {color: #800000; text-decoration-color: #800000; font-weight: bold}
.r12 {color: #000080; text-decoration-color: #000080}
.r13 {color: #87af00; text-decoration-color: #87af00}
.r14 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8; font-weight: bold}
.r15 {color: #000000; text-decoration-color: #000000; background-color: #f8f8f8}
.r16 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8; font-weight: bold}
.r17 {background-color: #f8f8f8}
.r18 {color: #666666; text-decoration-color: #666666; background-color: #f8f8f8}
.r19 {color: #008000; text-decoration-color: #008000; background-color: #f8f8f8}
.r20 {color: #0000ff; text-decoration-color: #0000ff; background-color: #f8f8f8}
.r21 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8}
.r22 {font-style: italic}
.r23 {color: #aa22ff; text-decoration-color: #aa22ff; background-color: #f8f8f8; font-weight: bold}
.r24 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8; font-style: italic}
.r25 {color: #ba2121; text-decoration-color: #ba2121; background-color: #f8f8f8}
.r26 {color: #0000ff; text-decoration-color: #0000ff}
body {
    color: #000000;
    background-color: #ffffff;
}
</style>
</head>
<html>
<body>
    <code>
        <pre style="font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                       Memory usage: <span class="r1">▄▅█</span> (max: 20.181 MB, growth rate: 100%)                                       
                           /dist/flax-fm/flaxfm/model/wd.py: % of time =  96.98% (1.960s) out of 2.021s.                           
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/dist/flax-fm/flaxfm/model/wd.py                   </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r11">    2%</span><span class="r12"> </span>│<span class="r11">   49%</span><span class="r12"> </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">import</span><span class="r15"> </span><span class="r16">numpy</span><span class="r15"> </span><span class="r14">as</span><span class="r15"> </span><span class="r16">np</span><span class="r17">                                </span>  
 <span class="r10">    2 </span>│<span class="r11">   25%</span><span class="r12"> </span>│<span class="r11">   19%</span><span class="r12"> </span>│<span class="r12">   1% </span>│<span class="r13">       </span>│<span class="r1">  98%  </span>│<span class="r1">   20M </span>│<span class="r11">▄█ 100%</span><span class="r1">        </span>│<span class="r13">   124 </span>│<span class="r14">import</span><span class="r15"> </span><span class="r16">jax</span><span class="r17">                                        </span>  
 <span class="r10">    3 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">from</span><span class="r15"> </span><span class="r16">flaxfm.layer</span><span class="r15"> </span><span class="r14">import</span><span class="r15"> FeaturesLinearFlax, Featu</span>  
 <span class="r10">    4 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">from</span><span class="r15"> </span><span class="r16">typing</span><span class="r15"> </span><span class="r14">import</span><span class="r15"> Sequence</span><span class="r17">                       </span>  
 <span class="r10">    5 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">from</span><span class="r15"> </span><span class="r16">flax</span><span class="r15"> </span><span class="r14">import</span><span class="r15"> linen </span><span class="r14">as</span><span class="r15"> nn</span><span class="r17">                      </span>  
 <span class="r10">    6 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">    7 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">WideAndDeepModelFlax</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Module):</span><span class="r17">            </span>  
 <span class="r10">    8 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    field_dims : np</span><span class="r18">.</span><span class="r15">ndarray</span><span class="r17">                       </span>  
 <span class="r10">    9 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    embed_dim : </span><span class="r19">int</span><span class="r17">                               </span>  
 <span class="r10">   10 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    mlp_dims : Sequence[</span><span class="r19">int</span><span class="r15">]</span><span class="r17">                      </span>  
 <span class="r10">   11 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    dropout : </span><span class="r19">float</span><span class="r15"> </span><span class="r18">=</span><span class="r15"> </span><span class="r18">0.2</span><span class="r17">                         </span>  
 <span class="r10">   12 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   13 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">setup</span><span class="r15">(</span><span class="r19">self</span><span class="r15">):</span><span class="r17">                              </span>  
 <span class="r10">   14 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">linear </span><span class="r18">=</span><span class="r15"> FeaturesLinearFlax(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">fiel</span>  
 <span class="r10">   15 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">embedding </span><span class="r18">=</span><span class="r15"> FeaturesEmbeddingFlax(</span><span class="r19">sel</span>  
 <span class="r10">   16 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">embed_output_dim </span><span class="r18">=</span><span class="r15"> </span><span class="r19">len</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">field_dim</span>  
 <span class="r10">   17 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">mlp </span><span class="r18">=</span><span class="r15"> MultiLayerPerceptronFlax(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">m</span>  
 <span class="r10">   18 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   19 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   20 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">   21 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, x, training</span><span class="r18">=</span><span class="r14">True</span><span class="r15">):</span><span class="r17">         </span>  
 <span class="r10">   22 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        embed_x </span><span class="r18">=</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">embedding(x)</span><span class="r17">               </span>  
 <span class="r10">   23 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        x </span><span class="r18">=</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">linear(x) </span><span class="r18">+</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">mlp(embed_x</span><span class="r18">.</span><span class="r15">resh</span>  
 <span class="r10">   24 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> jax</span><span class="r18">.</span><span class="r15">nn</span><span class="r18">.</span><span class="r15">sigmoid(x</span><span class="r18">.</span><span class="r15">squeeze(</span><span class="r18">1</span><span class="r15">))</span><span class="r17">       </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
Top PEAK memory consumption, by line:
<span class="r1">(1)     2:    20 MB</span>                                                                                                                 
<span class="r22">                           /dist/flax-fm/flaxfm/layer.py: % of time =   2.71% (54.755ms) out of 2.021s.                            </span>
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                    
 <span class="r2">      </span>│<span class="r3">Time</span><span class="r2">   </span>│<span class="r3">––––––</span><span class="r2"> </span>│<span class="r3">––––…</span><span class="r2"> </span>│<span class="r4">––––––</span><span class="r2"> </span>│<span class="r5">Memory</span><span class="r2"> </span>│<span class="r5">––––––</span><span class="r2"> </span>│<span class="r5">–––––––––––</span><span class="r2">    </span>│<span class="r4">Copy</span><span class="r2">   </span>│<span class="r2">                                                   </span> 
 <span class="r2"> </span><span class="r6">Line</span><span class="r2"> </span>│<span class="r7">Python</span><span class="r2"> </span>│<span class="r7">native</span><span class="r2"> </span>│<span class="r7">syst…</span><span class="r2"> </span>│<span class="r8">GPU</span><span class="r2">    </span>│<span class="r9">Python</span><span class="r2"> </span>│<span class="r9">peak</span><span class="r2">   </span>│<span class="r9">timeline</span><span class="r5">/%</span><span class="r2">     </span>│<span class="r8">(MB/s)</span><span class="r2"> </span>│<span class="r2">/dist/flax-fm/flaxfm/layer.py                      </span> 
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
 <span class="r10">    1 </span>│<span class="r12">    2% </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">from</span><span class="r15"> </span><span class="r16">flax</span><span class="r15"> </span><span class="r14">import</span><span class="r15"> linen </span><span class="r14">as</span><span class="r15"> nn</span><span class="r17">                      </span>  
 <span class="r10">    2 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">from</span><span class="r15"> </span><span class="r16">jax</span><span class="r15"> </span><span class="r14">import</span><span class="r15"> lax</span><span class="r17">                               </span>  
 <span class="r10">    3 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">import</span><span class="r15"> </span><span class="r16">numpy</span><span class="r15"> </span><span class="r14">as</span><span class="r15"> </span><span class="r16">np</span><span class="r17">                                </span>  
 <span class="r10">    4 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">import</span><span class="r15"> </span><span class="r16">jax</span><span class="r17">                                        </span>  
 <span class="r10">    5 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">import</span><span class="r15"> </span><span class="r16">jax.numpy</span><span class="r15"> </span><span class="r14">as</span><span class="r15"> </span><span class="r16">jnp</span><span class="r17">                           </span>  
 <span class="r10">    6 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">from</span><span class="r15"> </span><span class="r16">flaxfm.utils</span><span class="r15"> </span><span class="r14">import</span><span class="r15"> slicing</span><span class="r17">                  </span>  
 <span class="r10">    7 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">from</span><span class="r15"> </span><span class="r16">typing</span><span class="r15"> </span><span class="r14">import</span><span class="r15"> Sequence, Any</span><span class="r17">                  </span>  
 <span class="r10">    8 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">    9 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">FeaturesLinearFlax</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Module):</span><span class="r17">              </span>  
 <span class="r10">   10 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    field_dims : np</span><span class="r18">.</span><span class="r15">ndarray</span><span class="r17">                       </span>  
 <span class="r10">   11 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    output_dim : </span><span class="r19">int</span><span class="r15"> </span><span class="r18">=</span><span class="r15"> </span><span class="r18">1</span><span class="r17">                          </span>  
 <span class="r10">   12 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   13 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">setup</span><span class="r15">(</span><span class="r19">self</span><span class="r15">):</span><span class="r17">                              </span>  
 <span class="r10">   14 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">fc </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Embed(</span><span class="r19">sum</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">field_dims), </span><span class="r19">s</span>  
 <span class="r10">   15 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">offsets </span><span class="r18">=</span><span class="r15"> np</span><span class="r18">.</span><span class="r15">array((</span><span class="r18">0</span><span class="r15">, </span><span class="r18">*</span><span class="r15">np</span><span class="r18">.</span><span class="r15">cumsum(</span><span class="r19">sel</span>  
 <span class="r10">   16 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">   17 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, x):</span><span class="r17">                        </span>  
 <span class="r10">   18 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        x </span><span class="r18">=</span><span class="r15"> x</span><span class="r18">+</span><span class="r19">self</span><span class="r18">.</span><span class="r15">offsets</span><span class="r17">                        </span>  
 <span class="r10">   19 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> np</span><span class="r18">.</span><span class="r15">sum(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">fc(x), axis</span><span class="r18">=1</span><span class="r15">)</span><span class="r17">         </span>  
 <span class="r10">   20 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   21 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   22 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">FeaturesEmbeddingFlax</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Module):</span><span class="r17">           </span>  
 <span class="r10">   23 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    field_dims : np</span><span class="r18">.</span><span class="r15">ndarray</span><span class="r17">                       </span>  
 <span class="r10">   24 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    embed_dim : </span><span class="r19">int</span><span class="r15"> </span><span class="r18">=</span><span class="r15"> </span><span class="r18">16</span><span class="r17">                          </span>  
 <span class="r10">   25 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   26 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">setup</span><span class="r15">(</span><span class="r19">self</span><span class="r15">):</span><span class="r17">                              </span>  
 <span class="r10">   27 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">embedding </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Embed(</span><span class="r19">sum</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">field_d</span>  
 <span class="r10">   28 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">offsets </span><span class="r18">=</span><span class="r15"> np</span><span class="r18">.</span><span class="r15">array((</span><span class="r18">0</span><span class="r15">, </span><span class="r18">*</span><span class="r15">np</span><span class="r18">.</span><span class="r15">cumsum(</span><span class="r19">sel</span>  
 <span class="r10">   29 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   30 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">   31 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, x):</span><span class="r17">                        </span>  
 <span class="r10">   32 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        x </span><span class="r18">=</span><span class="r15"> x</span><span class="r18">+</span><span class="r19">self</span><span class="r18">.</span><span class="r15">offsets</span><span class="r17">                        </span>  
 <span class="r10">   33 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">embedding(x)</span><span class="r17">                  </span>  
 <span class="r10">   34 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   35 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   36 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">FactorizationMachineFlax</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Module):</span><span class="r17">        </span>  
 <span class="r10">   37 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    reduce_sum : </span><span class="r19">bool</span><span class="r15"> </span><span class="r18">=</span><span class="r15"> </span><span class="r14">True</span><span class="r17">                      </span>  
 <span class="r10">   38 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   39 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">   40 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, x):</span><span class="r17">                        </span>  
 <span class="r10">   41 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        square_of_sum </span><span class="r18">=</span><span class="r15"> np</span><span class="r18">.</span><span class="r15">sum(x, axis</span><span class="r18">=1</span><span class="r15">)</span><span class="r18">**2</span><span class="r17">      </span>  
 <span class="r10">   42 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        sum_of_square </span><span class="r18">=</span><span class="r15"> np</span><span class="r18">.</span><span class="r15">sum(x</span><span class="r18">**2</span><span class="r15">, axis</span><span class="r18">=1</span><span class="r15">)</span><span class="r17">      </span>  
 <span class="r10">   43 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        ix </span><span class="r18">=</span><span class="r15"> square_of_sum </span><span class="r18">-</span><span class="r15"> sum_of_square</span><span class="r17">        </span>  
 <span class="r10">   44 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">if</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">reduce_sum:</span><span class="r17">                       </span>  
 <span class="r10">   45 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            ix </span><span class="r18">=</span><span class="r15"> np</span><span class="r18">.</span><span class="r15">sum(ix, axis</span><span class="r18">=1</span><span class="r15">, keepdims</span><span class="r18">=</span><span class="r14">True</span><span class="r15">)</span>  
 <span class="r10">   46 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> </span><span class="r18">0.5*</span><span class="r15">ix</span><span class="r17">                             </span>  
 <span class="r10">   47 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   48 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   49 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">FieldAwareFactorizationMachineFlax</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Module</span>  
 <span class="r10">   50 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    field_dims : np</span><span class="r18">.</span><span class="r15">ndarray</span><span class="r17">                       </span>  
 <span class="r10">   51 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    embed_dim : </span><span class="r19">int</span><span class="r15"> </span><span class="r18">=</span><span class="r15"> </span><span class="r18">16</span><span class="r17">                          </span>  
 <span class="r10">   52 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   53 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">setup</span><span class="r15">(</span><span class="r19">self</span><span class="r15">):</span><span class="r17">                              </span>  
 <span class="r10">   54 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">num_fields </span><span class="r18">=</span><span class="r15"> </span><span class="r19">len</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">field_dims)</span><span class="r17">    </span>  
 <span class="r10">   55 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">embeddings </span><span class="r18">=</span><span class="r15"> [nn</span><span class="r18">.</span><span class="r15">Embed(</span><span class="r19">sum</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">field</span>  
 <span class="r10">   56 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">offsets </span><span class="r18">=</span><span class="r15"> np</span><span class="r18">.</span><span class="r15">array((</span><span class="r18">0</span><span class="r15">, </span><span class="r18">*</span><span class="r15">np</span><span class="r18">.</span><span class="r15">cumsum(</span><span class="r19">sel</span>  
 <span class="r10">   57 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   58 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   59 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">   60 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, x):</span><span class="r17">                        </span>  
 <span class="r10">   61 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        x </span><span class="r18">=</span><span class="r15"> x</span><span class="r18">+</span><span class="r19">self</span><span class="r18">.</span><span class="r15">offsets</span><span class="r17">                        </span>  
 <span class="r10">   62 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        xs </span><span class="r18">=</span><span class="r15"> [</span><span class="r19">self</span><span class="r18">.</span><span class="r15">embeddings[i](x) </span><span class="r14">for</span><span class="r15"> i </span><span class="r23">in</span><span class="r15"> </span><span class="r19">range</span>  
 <span class="r10">   63 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        ix </span><span class="r18">=</span><span class="r15"> </span><span class="r19">list</span><span class="r15">()</span><span class="r17">                               </span>  
 <span class="r10">   64 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">for</span><span class="r15"> i </span><span class="r23">in</span><span class="r15"> </span><span class="r19">range</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">num_fields </span><span class="r18">-</span><span class="r15"> </span><span class="r18">1</span><span class="r15">):</span><span class="r17">      </span>  
 <span class="r10">   65 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            </span><span class="r14">for</span><span class="r15"> j </span><span class="r23">in</span><span class="r15"> </span><span class="r19">range</span><span class="r15">(i </span><span class="r18">+</span><span class="r15"> </span><span class="r18">1</span><span class="r15">, </span><span class="r19">self</span><span class="r18">.</span><span class="r15">num_fields)</span>  
 <span class="r10">   66 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">                ix</span><span class="r18">.</span><span class="r15">append(slicing(xs[j],i,</span><span class="r18">1</span><span class="r15">) </span><span class="r18">*</span><span class="r15"> sli</span>  
 <span class="r10">   67 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        ix </span><span class="r18">=</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">stack(ix, axis</span><span class="r18">=1</span><span class="r15">)</span><span class="r17">                </span>  
 <span class="r10">   68 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">array(ix)</span><span class="r17">                      </span>  
 <span class="r10">   69 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   70 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   71 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">MultiLayerPerceptronFlax</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Module):</span><span class="r17">        </span>  
 <span class="r10">   72 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    embed_dims : Sequence[</span><span class="r19">int</span><span class="r15">]</span><span class="r17">                    </span>  
 <span class="r10">   73 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    dropout : </span><span class="r19">float</span><span class="r17">                               </span>  
 <span class="r10">   74 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   75 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">   76 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, x, training:</span><span class="r19">bool</span><span class="r18">=</span><span class="r14">True</span><span class="r15">, outp</span>  
 <span class="r10">   77 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">for</span><span class="r15"> embed_dim </span><span class="r23">in</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">embed_dims:</span><span class="r17">         </span>  
 <span class="r10">   78 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            x </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dense(embed_dim)(x)</span><span class="r17">            </span>  
 <span class="r10">   79 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            x </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">relu(x)</span><span class="r17">                        </span>  
 <span class="r10">   80 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            x </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">BatchNorm(use_running_average</span><span class="r18">=</span><span class="r23">n</span>  
 <span class="r10">   81 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            x </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dropout(rate</span><span class="r18">=</span><span class="r19">self</span><span class="r18">.</span><span class="r15">dropout, dete</span>  
 <span class="r10">   82 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   83 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">if</span><span class="r15"> output_layer:</span><span class="r17">                          </span>  
 <span class="r10">   84 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            x </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dense(</span><span class="r18">1</span><span class="r15">)(x)</span><span class="r17">                    </span>  
 <span class="r10">   85 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   86 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> x</span><span class="r17">                                  </span>  
 <span class="r10">   87 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   88 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">AttentionalFactorizationMachineFlax</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Modul</span>  
 <span class="r10">   89 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    attn_size : </span><span class="r19">int</span><span class="r17">                               </span>  
 <span class="r10">   90 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    dropout : </span><span class="r19">float</span><span class="r15"> </span><span class="r18">=</span><span class="r15"> </span><span class="r18">0.2</span><span class="r17">                         </span>  
 <span class="r10">   91 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   92 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">setup</span><span class="r15">(</span><span class="r19">self</span><span class="r15">):</span><span class="r17">                              </span>  
 <span class="r10">   93 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">attention </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dense(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">attn_size)</span><span class="r17"> </span>  
 <span class="r10">   94 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">projection </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dense(</span><span class="r18">1</span><span class="r15">)</span><span class="r17">             </span>  
 <span class="r10">   95 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">fc </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dense(</span><span class="r18">1</span><span class="r15">)</span><span class="r17">                     </span>  
 <span class="r10">   96 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">   97 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">   98 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, x, training:</span><span class="r19">bool</span><span class="r18">=</span><span class="r14">True</span><span class="r15">):</span><span class="r17">    </span>  
 <span class="r10">   99 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        num_fields </span><span class="r18">=</span><span class="r15"> x</span><span class="r18">.</span><span class="r15">shape[</span><span class="r18">1</span><span class="r15">]</span><span class="r17">                   </span>  
 <span class="r10">  100 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        row, col </span><span class="r18">=</span><span class="r15"> [], []</span><span class="r17">                         </span>  
 <span class="r10">  101 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">for</span><span class="r15"> i </span><span class="r23">in</span><span class="r15"> </span><span class="r19">range</span><span class="r15">(num_fields </span><span class="r18">-1</span><span class="r15">):</span><span class="r17">            </span>  
 <span class="r10">  102 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            </span><span class="r14">for</span><span class="r15"> j </span><span class="r23">in</span><span class="r15"> </span><span class="r19">range</span><span class="r15">(i</span><span class="r18">+1</span><span class="r15">, num_fields):</span><span class="r17">      </span>  
 <span class="r10">  103 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">                row</span><span class="r18">.</span><span class="r15">append(i), col</span><span class="r18">.</span><span class="r15">append(j)</span><span class="r17">      </span>  
 <span class="r10">  104 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        p, q </span><span class="r18">=</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">expand_dims(slicing(x, row[</span><span class="r18">0</span><span class="r15">], </span>  
 <span class="r10">  105 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        inner_product </span><span class="r18">=</span><span class="r15"> p</span><span class="r18">*</span><span class="r15">q</span><span class="r17">                       </span>  
 <span class="r10">  106 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        attn_scores </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">relu(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">attention(inner</span>  
 <span class="r10">  107 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        attn_scores </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">softmax(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">projection(a</span>  
 <span class="r10">  108 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        attn_scores </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dropout(rate</span><span class="r18">=</span><span class="r19">self</span><span class="r18">.</span><span class="r15">dropout</span>  
 <span class="r10">  109 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        attn_output </span><span class="r18">=</span><span class="r15"> np</span><span class="r18">.</span><span class="r15">sum(attn_scores </span><span class="r18">*</span><span class="r15"> inner_p</span>  
 <span class="r10">  110 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        attn_output </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dropout(rate</span><span class="r18">=</span><span class="r19">self</span><span class="r18">.</span><span class="r15">dropout</span>  
 <span class="r10">  111 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">fc(attn_output)</span><span class="r17">               </span>  
 <span class="r10">  112 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  113 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  114 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  115 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">CompressedInteractionNetworkFlax</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Module):</span>  
 <span class="r10">  116 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r24">&quot;&quot;&quot;</span><span class="r17">                                           </span>  
 <span class="r10">  117 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r24">    #TODO(23/01/07): this network is working well,</span>  
 <span class="r10">  118 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r24">                    The shape of output of conv_la</span>  
 <span class="r10">  119 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r24">                    Fix the code when I know how t</span>  
 <span class="r10">  120 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r24">    &quot;&quot;&quot;</span><span class="r17">                                           </span>  
 <span class="r10">  121 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    input_dim : </span><span class="r19">int</span><span class="r17">                               </span>  
 <span class="r10">  122 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    cross_layer_sizes : Sequence[</span><span class="r19">int</span><span class="r15">]</span><span class="r17">             </span>  
 <span class="r10">  123 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    split_half : </span><span class="r19">bool</span><span class="r17">                             </span>  
 <span class="r10">  124 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  125 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">setup</span><span class="r15">(</span><span class="r19">self</span><span class="r15">):</span><span class="r17">                              </span>  
 <span class="r10">  126 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">num_layers </span><span class="r18">=</span><span class="r15"> </span><span class="r19">len</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">cross_layer_siz</span>  
 <span class="r10">  127 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r19">self</span><span class="r18">.</span><span class="r15">fc </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">Dense(</span><span class="r18">1</span><span class="r15">)</span><span class="r17">                     </span>  
 <span class="r10">  128 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  129 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">  130 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, x):</span><span class="r17">                        </span>  
 <span class="r10">  131 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        prev_dim, fc_input_dim </span><span class="r18">=</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">input_dim, </span><span class="r18">0</span>  
 <span class="r10">  132 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        conv_layers </span><span class="r18">=</span><span class="r15"> </span><span class="r19">list</span><span class="r15">()</span><span class="r17">                      </span>  
 <span class="r10">  133 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">for</span><span class="r15"> i </span><span class="r23">in</span><span class="r15"> </span><span class="r19">range</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">num_layers):</span><span class="r17">          </span>  
 <span class="r10">  134 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            cross_layer_size </span><span class="r18">=</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">cross_layer_si</span>  
 <span class="r10">  135 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            conv_layers</span><span class="r18">.</span><span class="r15">append(nn</span><span class="r18">.</span><span class="r15">Conv(cross_layer</span>  
 <span class="r10">  136 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            </span><span class="r14">if</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">split_half </span><span class="r23">and</span><span class="r15"> i </span><span class="r18">!=</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">num_l</span>  
 <span class="r10">  137 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">                cross_layer_size </span><span class="r18">//=</span><span class="r15"> </span><span class="r18">2</span><span class="r17">            </span>  
 <span class="r10">  138 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            prev_dim </span><span class="r18">=</span><span class="r15"> cross_layer_size</span><span class="r17">           </span>  
 <span class="r10">  139 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            fc_input_dim </span><span class="r18">+=</span><span class="r15"> prev_dim</span><span class="r17">              </span>  
 <span class="r10">  140 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  141 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  142 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        xs </span><span class="r18">=</span><span class="r15"> </span><span class="r19">list</span><span class="r15">()</span><span class="r17">                               </span>  
 <span class="r10">  143 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        x0, h </span><span class="r18">=</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">expand_dims(x, axis</span><span class="r18">=2</span><span class="r15">), x</span><span class="r17">     </span>  
 <span class="r10">  144 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">for</span><span class="r15"> i </span><span class="r23">in</span><span class="r15"> </span><span class="r19">range</span><span class="r15">(</span><span class="r19">self</span><span class="r18">.</span><span class="r15">num_layers):</span><span class="r17">          </span>  
 <span class="r10">  145 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            x </span><span class="r18">=</span><span class="r15"> x0 </span><span class="r18">*</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">expand_dims(h, axis</span><span class="r18">=1</span><span class="r15">)</span><span class="r17">   </span>  
 <span class="r10">  146 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            batch_size, f0_dim, fin_dim, embed_dim</span>  
 <span class="r10">  147 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            x </span><span class="r18">=</span><span class="r15"> x</span><span class="r18">.</span><span class="r15">reshape(batch_size, f0_dim</span><span class="r18">*</span><span class="r15">fin_d</span>  
 <span class="r10">  148 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            x </span><span class="r18">=</span><span class="r15"> nn</span><span class="r18">.</span><span class="r15">relu(conv_layers[i](x))</span><span class="r17">        </span>  
 <span class="r10">  149 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            </span><span class="r14">if</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">split_half </span><span class="r23">and</span><span class="r15"> i </span><span class="r18">!=</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">num_l</span>  
 <span class="r10">  150 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">                x, h </span><span class="r18">=</span><span class="r15"> torch</span><span class="r18">.</span><span class="r15">split(x, x</span><span class="r18">.</span><span class="r15">shape[</span><span class="r18">1</span><span class="r15">] </span><span class="r18">/</span>  
 <span class="r10">  151 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            </span><span class="r14">else</span><span class="r15">:</span><span class="r17">                                 </span>  
 <span class="r10">  152 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">                h </span><span class="r18">=</span><span class="r15"> x</span><span class="r17">                             </span>  
 <span class="r10">  153 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            xs</span><span class="r18">.</span><span class="r15">append(x)</span><span class="r17">                          </span>  
 <span class="r10">  154 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">fc(jnp</span><span class="r18">.</span><span class="r15">sum(jnp</span><span class="r18">.</span><span class="r15">concatenate(xs,</span>  
 <span class="r10">  155 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  156 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  157 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r14">class</span><span class="r15"> </span><span class="r16">FlaxConv1D</span><span class="r15">(nn</span><span class="r18">.</span><span class="r15">Module):</span><span class="r17">                      </span>  
 <span class="r10">  158 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r24">&quot;&quot;&quot;</span><span class="r17">                                           </span>  
 <span class="r10">  159 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r24">    reference : https://huggingface.co/transformer</span>  
 <span class="r10">  160 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r24">    &quot;&quot;&quot;</span><span class="r17">                                           </span>  
 <span class="r10">  161 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    features: </span><span class="r19">int</span><span class="r17">                                 </span>  
 <span class="r10">  162 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    use_bias: </span><span class="r19">bool</span><span class="r15"> </span><span class="r18">=</span><span class="r15"> </span><span class="r14">True</span><span class="r17">                         </span>  
 <span class="r10">  163 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    dtype: Any </span><span class="r18">=</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">float32</span><span class="r17">                      </span>  
 <span class="r10">  164 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    precision: Any </span><span class="r18">=</span><span class="r15"> </span><span class="r14">None</span><span class="r17">                         </span>  
 <span class="r10">  165 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r17">                                                  </span>  
 <span class="r10">  166 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r21">@nn</span><span class="r18">.</span><span class="r15">compact</span><span class="r17">                                   </span>  
 <span class="r10">  167 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">    </span><span class="r14">def</span><span class="r15"> </span><span class="r20">__call__</span><span class="r15">(</span><span class="r19">self</span><span class="r15">, inputs):</span><span class="r17">                   </span>  
 <span class="r10">  168 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        inputs </span><span class="r18">=</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">asarray(inputs, </span><span class="r19">self</span><span class="r18">.</span><span class="r15">dtype)</span><span class="r17">  </span>  
 <span class="r10">  169 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        kernel </span><span class="r18">=</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">param(</span><span class="r25">&quot;kernel&quot;</span><span class="r15">, jax</span><span class="r18">.</span><span class="r15">nn</span><span class="r18">.</span><span class="r15">initi</span>  
 <span class="r10">  170 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        kernel </span><span class="r18">=</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">asarray(kernel</span><span class="r18">.</span><span class="r15">transpose(), </span><span class="r19">s</span>  
 <span class="r10">  171 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        y </span><span class="r18">=</span><span class="r15"> lax</span><span class="r18">.</span><span class="r15">dot_general(inputs, kernel, (((inp</span>  
 <span class="r10">  172 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">if</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">use_bias:</span><span class="r17">                         </span>  
 <span class="r10">  173 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            bias </span><span class="r18">=</span><span class="r15"> </span><span class="r19">self</span><span class="r18">.</span><span class="r15">param(</span><span class="r25">&quot;bias&quot;</span><span class="r15">, jax</span><span class="r18">.</span><span class="r15">nn</span><span class="r18">.</span><span class="r15">initi</span>  
 <span class="r10">  174 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            bias </span><span class="r18">=</span><span class="r15"> jnp</span><span class="r18">.</span><span class="r15">asarray(bias, </span><span class="r19">self</span><span class="r18">.</span><span class="r15">dtype)</span><span class="r17">  </span>  
 <span class="r10">  175 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">            y </span><span class="r18">=</span><span class="r15"> y </span><span class="r18">+</span><span class="r15"> bias</span><span class="r17">                          </span>  
 <span class="r10">  176 </span>│<span class="r12">       </span>│<span class="r12">       </span>│<span class="r12">      </span>│<span class="r13">       </span>│<span class="r1">       </span>│<span class="r1">       </span>│<span class="r1">               </span>│<span class="r13">       </span>│<span class="r15">        </span><span class="r14">return</span><span class="r15"> y</span><span class="r17">                                  </span>  
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                    
generated by the <a class="r26" href="https://github.com/plasma-umass/scalene">scalene</a> profiler                                                                                                   
</pre>
    </code>
</body>
</html>
